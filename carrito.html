<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout y Carrito</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background:#f8f8f8; color:#333; }
        .container-shadow { box-shadow:0 10px 25px rgba(0,0,0,0.1); }
        .carrito-item-page { display:flex; justify-content:space-between; align-items:center; padding:1rem 0; border-bottom:1px solid #eee; }
        .carrito-item-info-page { display:flex; align-items:center; gap:1rem; }
        .carrito-item-info-page img { width:70px; height:70px; object-fit:cover; border-radius:8px; }
        .carrito-item-precio { font-weight:700; color:#D45510; min-width:80px; text-align:right; }
        .remove-btn-page { background:none; border:none; cursor:pointer; font-size:1.1rem; margin-left:10px; }
        .input-style { padding:0.75rem; border:1px solid #ccc; border-radius:8px; }
        .cantidad-input { appearance:textfield; }
        .cantidad-input::-webkit-outer-spin-button, .cantidad-input::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }
        .btn-volver { display: inline-block; margin-bottom: 20px; color: #D45510; font-weight: 600; text-decoration: none; }
        .btn-volver:hover { text-decoration: underline; }
    </style>
</head>
<body class="p-4 md:p-8">
    <script>window.addEventListener('DOMContentLoaded', ()=>document.body.classList.add('loaded'))</script>

    <div class="max-w-7xl mx-auto">
        <a href="index.html" class="btn-volver">← Volver a la tienda</a>
    </div>

    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-2">Finalizar Compra</h1>

        <div class="flex flex-col lg:flex-row gap-8">
            <div class="lg:w-7/12 bg-white p-6 rounded-xl container-shadow">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Tu Carrito de Compras</h2>
                <div id="carrito-lista">
                    <div class="text-center p-8 text-gray-500">Cargando carrito...</div>
                </div>

                <div class="mt-8 pt-4 border-t border-gray-200">
                    <div class="flex justify-between text-lg mb-2 total-summary"><span>Subtotal:</span><span id="subtotal">$0.00</span></div>
                    <div class="flex justify-between text-lg mb-2 total-summary"><span>Impuestos (19%):</span><span id="impuestos">$0.00</span></div>
                    <div class="flex justify-between text-2xl font-bold pt-2 border-t mt-4 border-gray-300 total-summary"><span>Total:</span><span id="total" class="text-2xl text-red-600">$0.00</span></div>
                </div>
            </div>

            <div class="lg:w-5/12 bg-white p-6 rounded-xl container-shadow">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Detalles de Envío y Pago</h2>
                <form id="checkoutForm" class="space-y-4">
                    <h3 class="text-xl font-medium pt-2 border-t border-gray-100 mt-4">Información de Contacto</h3>
                    <input type="text" id="nombre" name="nombre" placeholder="Nombre Completo" required class="w-full input-style">
                    <input type="email" id="correo" name="correo" placeholder="Correo Electrónico" required class="w-full input-style">

                    <h3 class="text-xl font-medium pt-2 border-t border-gray-100 mt-4">Dirección de Envío</h3>
                    <input type="text" id="direccion" name="direccion" placeholder="Dirección" required class="w-full input-style">
                    <div class="flex space-x-4">
                        <input type="text" id="ciudad" name="ciudad" placeholder="Ciudad" required class="w-1/2 input-style">
                        <input type="tel" id="telefono" name="telefono" placeholder="Teléfono" required class="w-1/2 input-style">
                    </div>

                    <h3 class="text-xl font-medium pt-2 border-t border-gray-100 mt-4">Información de Pago (Simulada)</h3>
                    <input type="text" id="tarjeta" name="tarjeta" placeholder="Número de Tarjeta (XXXX XXXX XXXX XXXX)" required pattern="[\d ]{16,19}" class="w-full input-style">
                    <div class="flex space-x-4">
                        <input type="text" id="expiracion" name="expiracion" placeholder="MM/AA" required class="w-1/2 input-style">
                        <input type="text" id="cvv" name="cvv" placeholder="CVV" required class="w-1/2 input-style">
                    </div>

                    <button type="submit" id="checkout-btn" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-xl">Pagar Ahora y Guardar Pedido</button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, registrarPedido } from './firebase.js';

        let currentCartItems = [];

        function tryParseJSON(raw){ try{ return raw ? JSON.parse(raw) : null; }catch(e){ return null; } }
        
        function normalizeCartData(raw){
            if(!raw) return [];
            if(Array.isArray(raw)) return raw;
            if(typeof raw === 'object'){
                const keys = Object.keys(raw);
                if(keys.length && keys.every(k=> typeof raw[k] === 'object')){
                    return keys.map(k=> Object.assign({ id:k }, raw[k]));
                }
            }
            return [];
        }

        function loadCartFromLocalStorage(){
            const raw = localStorage.getItem('carrito');
            const parsed = tryParseJSON(raw);
            let normalized = normalizeCartData(parsed);
            if((!normalized || normalized.length===0) && parsed && typeof parsed === 'object' && parsed.nombre){
                normalized = [parsed];
            }
            currentCartItems = (normalized||[]).map(it=>({
                id: it.id || it.nombre || Math.random().toString(36).slice(2,9),
                nombre: it.nombre || it.title || 'Producto',
                precio: Number(it.precio || it.price || it.valor || 0),
                cantidad: Number(it.cantidad || it.qty || 1),
                imagen: it.imagen || it.image || it.imagenPrincipal || ''
            }));
        }

        function saveCartToLocalStorage(){ try{ localStorage.setItem('carrito', JSON.stringify(currentCartItems)); }catch(e){ console.warn('No se pudo guardar el carrito', e); } }

        function calculateSummary(items){ const TAX_RATE = 0.19; const subtotal = (items||[]).reduce((s,it)=> s + (Number(it.precio)||0) * (Number(it.cantidad)||0), 0); const taxes = subtotal * TAX_RATE; const total = subtotal + taxes; return { subtotal: subtotal.toFixed(2), taxes: taxes.toFixed(2), total: total.toFixed(2) }; }

        function escapeHtml(s){ return String(s||'').replace(/[&<>'\"]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;',"'":"&#39;",'"':'&quot;'}[m])); }

        function renderCart(items){
            const listaEl = document.getElementById('carrito-lista');
            const subtotalEl = document.getElementById('subtotal');
            const impuestosEl = document.getElementById('impuestos');
            const totalEl = document.getElementById('total');
            const debugEl = document.getElementById('cart-debug');
            if(!listaEl||!subtotalEl||!impuestosEl||!totalEl) return;
            listaEl.innerHTML = '';
            if(!items||items.length===0){ listaEl.innerHTML = '<div class="text-center p-8 text-gray-500 bg-gray-50 rounded-lg">Tu carrito está vacío. ¡Agrega algunos productos!</div>'; subtotalEl.textContent = '$0.00'; impuestosEl.textContent = '$0.00'; totalEl.textContent = '$0.00'; if(debugEl) debugEl.textContent = 'Debug: parsedCount=0'; return; }
            items.forEach(item=>{
                const itemTotal = ((Number(item.precio)||0) * (Number(item.cantidad)||0)).toFixed(2);
                const imageUrl = item.imagen || ('https://placehold.co/70x70/D45510/ffffff?text=' + encodeURIComponent((item.nombre||'P').charAt(0)));
                const container = document.createElement('div');
                container.className = 'carrito-item-page';
                container.dataset.docId = item.id;
                container.innerHTML = `
                    <div class="carrito-item-info-page">
                        <img src="${escapeHtml(imageUrl)}" onerror="this.onerror=null;this.src='https://placehold.co/70x70/D45510/ffffff?text=Prod'" alt="${escapeHtml(item.nombre)}">
                        <div>
                            <span class="nombre font-medium text-gray-800">${escapeHtml(item.nombre)}</span>
                            <div style="font-size:0.9rem; color:#666; margin-top:0.2rem;">Cantidad: <input type="number" min="1" value="${escapeHtml(item.cantidad)}" data-item-id="${escapeHtml(item.id)}" class="cantidad-input px-2 py-1 border border-gray-300 rounded-md text-center focus:border-orange-500" style="width:60px;"></div>
                        </div>
                    </div>
                ` + `<div style="display:flex; align-items:center; gap:8px;"><span class="carrito-item-precio">$${itemTotal}</span><button class="remove-btn-page" data-item-id="${escapeHtml(item.id)}" style="background:none;border:none;cursor:pointer;font-size:1.1rem;">✖</button></div>`;
                listaEl.appendChild(container);
            });
            const summary = calculateSummary(items);
            subtotalEl.textContent = '$' + summary.subtotal;
            impuestosEl.textContent = '$' + summary.taxes;
            totalEl.textContent = '$' + summary.total;
            if(debugEl) debugEl.textContent = 'Debug: parsedCount=' + (items.length || 0);
        }

        function showTemporaryMessage(message, type='info'){ const existing = document.getElementById('temp-message'); if(existing) existing.remove(); const msg = document.createElement('div'); msg.id='temp-message'; msg.textContent=message; let bg = '#4CAF50'; if(type==='error') bg='#D45510'; if(type==='info') bg='#2196F3'; msg.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:'+bg+';color:#fff;padding:12px 18px;border-radius:8px;z-index:10000;opacity:0;transition:opacity .3s, bottom .3s;'; document.body.appendChild(msg); setTimeout(()=>{ msg.style.opacity='1'; msg.style.bottom='30px'; },10); setTimeout(()=>{ msg.style.opacity='0'; msg.style.bottom='10px'; setTimeout(()=>msg.remove(),300); },3500); }

        function removeItemLocal(itemId){ currentCartItems = (currentCartItems||[]).filter(i=>String(i.id)!==String(itemId)); saveCartToLocalStorage(); renderCart(currentCartItems); showTemporaryMessage('Item eliminado del carrito','info'); }
        function updateQuantityLocal(itemId, newQty){ const idx = (currentCartItems||[]).findIndex(i=>String(i.id)===String(itemId)); if(idx<0) return; currentCartItems[idx].cantidad = Number(newQty)||1; saveCartToLocalStorage(); renderCart(currentCartItems); showTemporaryMessage('Cantidad actualizada','info'); }

        document.addEventListener('click', (e)=>{ const btn = e.target.closest('.remove-btn-page'); if(!btn) return; const id = btn.dataset.itemId; removeItemLocal(id); });
        document.addEventListener('input', (e)=>{ if(!e.target.classList.contains('cantidad-input')) return; const id = e.target.dataset.itemId; let q = parseInt(e.target.value); if(isNaN(q)||q<1){ e.target.value=1; q=1; } clearTimeout(e.target._deb); e.target._deb = setTimeout(()=> updateQuantityLocal(id,q), 300); });

        window.addEventListener('storage', (e)=>{ if(e.key === 'carrito'){ loadCartFromLocalStorage(); renderCart(currentCartItems); } });

        document.addEventListener('DOMContentLoaded', ()=>{ 
            const aside = document.createElement('div'); 
            aside.id = 'cart-debug'; 
            aside.style.cssText = 'position:fixed;right:12px;bottom:12px;background:rgba(0,0,0,0.6);color:#fff;padding:8px 10px;border-radius:6px;font-size:12px;z-index:9999;opacity:0.8;display:none;';
            document.body.appendChild(aside); 
            loadCartFromLocalStorage(); 
            renderCart(currentCartItems); 
        });

        document.addEventListener('submit', async (e)=>{ 
            if(e.target && e.target.id==='checkoutForm'){ 
                e.preventDefault(); 
                
                if(!currentCartItems||currentCartItems.length===0){ 
                    // Usamos Swal para errores también
                    Swal.fire({ icon: 'error', title: 'Oops...', text: 'El carrito está vacío', confirmButtonColor: '#D45510' });
                    return; 
                } 
                
                const user = auth.currentUser;
                if (!user) {
                    Swal.fire({ icon: 'warning', title: 'Inicia sesión', text: 'Para procesar el pedido debes iniciar sesión primero.', confirmButtonColor: '#D45510' });
                    return;
                }

                const btn = document.getElementById('checkout-btn'); 
                btn.disabled=true; 
                btn.textContent='Procesando...'; 

                try {
                    const datosEnvio = {
                        nombre: document.getElementById('nombre').value,
                        correo: document.getElementById('correo').value,
                        direccion: document.getElementById('direccion').value,
                        ciudad: document.getElementById('ciudad').value,
                        telefono: document.getElementById('telefono').value
                    };

                    let subtotal = 0;
                    currentCartItems.forEach(i => subtotal += (Number(i.precio)||0) * (Number(i.cantidad)||0));
                    const total = subtotal * 1.19;

                    const pedidoData = {
                        uidUsuario: user.uid,
                        emailUsuario: user.email,
                        fecha: new Date(),
                        productos: currentCartItems,
                        envio: datosEnvio,
                        total: total,
                        estado: "pendiente"
                    };

                    const idPedido = await registrarPedido(pedidoData);

                    currentCartItems = []; 
                    saveCartToLocalStorage(); 
                    renderCart(currentCartItems); 
                    btn.disabled=false; 
                    btn.textContent='Pagar Ahora y Vaciar Carrito'; 

                    // 2. ESTE ES EL AVISO NUEVO Y BONITO (SweetAlert2)
                    Swal.fire({
                      title: '¡Pedido Exitoso!',
                      text: 'Tu ID de pedido es: ' + idPedido,
                      icon: 'success', // Esto pone el chulito verde animado
                      confirmButtonText: 'Aceptar',
                      confirmButtonColor: '#D45510',
                      footer: '<p>Gracias por tu compra</p>'
                    }).then((result) => {
                      if (result.isConfirmed) {
                         // Redirigir al inicio cuando le den click en Aceptar
                         window.location.href = 'index.html';
                      }
                    });

                    document.getElementById('checkoutForm')?.reset();

                } catch (error) {
                    console.error("Error al comprar:", error);
                    Swal.fire({ icon: 'error', title: 'Error', text: 'Hubo un error al guardar el pedido.', confirmButtonColor: '#D45510' });
                    btn.disabled=false; 
                    btn.textContent='Pagar Ahora y Vaciar Carrito'; 
                }
            } 
        });
    </script>
</body>
</html>